"use strict";var e=require("@babel/runtime/helpers/extends"),n=require("react"),r=require("@react-three/fiber"),t=require("three"),o=require("three-stdlib"),u=require("./useEnvironment.cjs.js");function a(e){var n=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var t=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(n,r,t.get?t:{enumerable:!0,get:function(){return e[r]}})}})),n.default=e,Object.freeze(n)}require("@monogrid/gainmap-js"),require("../helpers/environment-assets.cjs.js"),require("../helpers/deprecated.cjs.js");var i=a(n);function c(e,n,t,o,u={}){var a,i,c,s,l;u={backgroundBlurriness:null!==(a=u.blur)&&void 0!==a?a:0,backgroundIntensity:1,backgroundRotation:[0,0,0],environmentIntensity:1,environmentRotation:[0,0,0],...u};const d=(e=>{return(n=e).current&&n.current.isScene?e.current:e;var n})(n||t),m=d.background,b=d.environment,g={backgroundBlurriness:d.backgroundBlurriness,backgroundIntensity:d.backgroundIntensity,backgroundRotation:null!==(i=null==(c=d.backgroundRotation)||null==c.clone?void 0:c.clone())&&void 0!==i?i:[0,0,0],environmentIntensity:d.environmentIntensity,environmentRotation:null!==(s=null==(l=d.environmentRotation)||null==l.clone?void 0:l.clone())&&void 0!==s?s:[0,0,0]};return"only"!==e&&(d.environment=o),e&&(d.background=o),r.applyProps(d,u),()=>{"only"!==e&&(d.environment=b),e&&(d.background=m),r.applyProps(d,g)}}function s({scene:e,background:n=!1,map:t,...o}){const u=r.useThree((e=>e.scene));return i.useLayoutEffect((()=>{if(t)return c(n,e,u,t,o)})),null}function l({background:e=!1,scene:n,blur:t,backgroundBlurriness:o,backgroundIntensity:a,backgroundRotation:s,environmentIntensity:l,environmentRotation:d,...m}){const b=u.useEnvironment(m),g=r.useThree((e=>e.scene));return i.useLayoutEffect((()=>c(e,n,g,b,{blur:t,backgroundBlurriness:o,backgroundIntensity:a,backgroundRotation:s,environmentIntensity:l,environmentRotation:d}))),null}function d({children:e,near:n=1,far:o=1e3,resolution:u=256,frames:a=1,map:d,background:m=!1,blur:b,backgroundBlurriness:g,backgroundIntensity:v,backgroundRotation:p,environmentIntensity:f,environmentRotation:k,scene:y,files:E,path:h,preset:I,extensions:R}){const j=r.useThree((e=>e.gl)),x=r.useThree((e=>e.scene)),q=i.useRef(null),[P]=i.useState((()=>new t.Scene)),B=i.useMemo((()=>{const e=new t.WebGLCubeRenderTarget(u);return e.texture.type=t.HalfFloatType,e}),[u]);i.useLayoutEffect((()=>(1===a&&q.current.update(j,P),c(m,y,x,B.texture,{blur:b,backgroundBlurriness:g,backgroundIntensity:v,backgroundRotation:p,environmentIntensity:f,environmentRotation:k}))),[e,P,B.texture,y,x,m,a,j]);let O=1;return r.useFrame((()=>{(a===1/0||O<a)&&(q.current.update(j,P),O++)})),i.createElement(i.Fragment,null,r.createPortal(i.createElement(i.Fragment,null,e,i.createElement("cubeCamera",{ref:q,args:[n,o,B]}),E||I?i.createElement(l,{background:!0,files:E,preset:I,path:h,extensions:R}):d?i.createElement(s,{background:!0,map:d,extensions:R}):null),P))}function m(n){var t,a,c,l;const d=u.useEnvironment(n),m=n.map||d;i.useMemo((()=>r.extend({GroundProjectedEnvImpl:o.GroundProjectedEnv})),[]);const b=i.useMemo((()=>[m]),[m]),g=null==(t=n.ground)?void 0:t.height,v=null==(a=n.ground)?void 0:a.radius,p=null!==(c=null==(l=n.ground)?void 0:l.scale)&&void 0!==c?c:1e3;return i.createElement(i.Fragment,null,i.createElement(s,e({},n,{map:m})),i.createElement("groundProjectedEnvImpl",{args:b,scale:p,height:g,radius:v}))}exports.Environment=function(e){return e.ground?i.createElement(m,e):e.map?i.createElement(s,e):e.children?i.createElement(d,e):i.createElement(l,e)},exports.EnvironmentCube=l,exports.EnvironmentMap=s,exports.EnvironmentPortal=d;
