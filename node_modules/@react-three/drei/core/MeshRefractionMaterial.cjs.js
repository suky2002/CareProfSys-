"use strict";var e=require("@babel/runtime/helpers/extends"),r=require("react"),t=require("@react-three/fiber"),a=require("three-mesh-bvh"),n=require("../materials/MeshRefractionMaterial.cjs.js");function i(e){var r=Object.create(null);return e&&Object.keys(e).forEach((function(t){if("default"!==t){var a=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,a.get?a:{enumerable:!0,get:function(){return e[t]}})}})),r.default=e,Object.freeze(r)}require("three"),require("./shaderMaterial.cjs.js"),require("../helpers/constants.cjs.js");var s=i(r);exports.MeshRefractionMaterial=function({aberrationStrength:i=0,fastChroma:o=!0,envMap:u,...c}){t.extend({MeshRefractionMaterial:n.MeshRefractionMaterial});const h=r.useRef(),{size:l}=t.useThree(),M=r.useMemo((()=>{var e,r;const t={},a=(n=u)&&n.isCubeTexture;var n;const s=(null!==(e=a?null==(r=u.image[0])?void 0:r.width:u.image.width)&&void 0!==e?e:1024)/4,c=Math.floor(Math.log2(s)),h=Math.pow(2,c),l=3*Math.max(h,112),M=4*h;return a&&(t.ENVMAP_TYPE_CUBEM=""),t.CUBEUV_TEXEL_WIDTH=""+1/l,t.CUBEUV_TEXEL_HEIGHT=""+1/M,t.CUBEUV_MAX_MIP=`${c}.0`,i>0&&(t.CHROMATIC_ABERRATIONS=""),o&&(t.FAST_CHROMA=""),t}),[i,o]);return r.useLayoutEffect((()=>{var e;const r=null==(e=h.current)||null==(e=e.__r3f)||null==(e=e.parent)?void 0:e.geometry;r&&(h.current.bvh=new a.MeshBVHUniformStruct,h.current.bvh.updateFrom(new a.MeshBVH(r.clone().toNonIndexed(),{strategy:a.SAH})))}),[]),t.useFrame((({camera:e})=>{h.current.viewMatrixInverse=e.matrixWorld,h.current.projectionMatrixInverse=e.projectionMatrixInverse})),s.createElement("meshRefractionMaterial",e({key:JSON.stringify(M),defines:M,ref:h,resolution:[l.width,l.height],aberrationStrength:i,envMap:u},c))};
