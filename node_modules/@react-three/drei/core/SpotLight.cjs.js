"use strict";var e=require("@babel/runtime/helpers/extends"),t=require("react"),r=require("three"),a=require("@react-three/fiber"),n=require("three-stdlib"),o=require("../materials/SpotLightMaterial.cjs.js");function i(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var a=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,a.get?a:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}require("../helpers/constants.cjs.js");var u=i(t);function l({opacity:e=1,radiusTop:t,radiusBottom:n,depthBuffer:i,color:l="white",distance:s=5,angle:c=.15,attenuation:p=5,anglePower:m=5}){const d=u.useRef(null),h=a.useThree((e=>e.size)),f=a.useThree((e=>e.camera)),g=a.useThree((e=>e.viewport.dpr)),[v]=u.useState((()=>new o.SpotLightMaterial)),[w]=u.useState((()=>new r.Vector3));t=void 0===t?.1:t,n=void 0===n?7*c:n,a.useFrame((()=>{v.uniforms.spotPosition.value.copy(d.current.getWorldPosition(w)),d.current.lookAt(d.current.parent.target.getWorldPosition(w))}));const S=u.useMemo((()=>{const e=new r.CylinderGeometry(t,n,s,128,64,!0);return e.applyMatrix4((new r.Matrix4).makeTranslation(0,-s/2,0)),e.applyMatrix4((new r.Matrix4).makeRotationX(-Math.PI/2)),e}),[s,t,n]);return u.createElement(u.Fragment,null,u.createElement("mesh",{ref:d,geometry:S,raycast:()=>null},u.createElement("primitive",{object:v,attach:"material","uniforms-opacity-value":e,"uniforms-lightColor-value":l,"uniforms-attenuation-value":p,"uniforms-anglePower-value":m,"uniforms-depth-value":i,"uniforms-cameraNear-value":f.near,"uniforms-cameraFar-value":f.far,"uniforms-resolution-value":i?[h.width*g,h.height*g]:[0,0]})))}function s(e,t,n,o,i){const[[l,s]]=u.useState((()=>[new r.Vector3,new r.Vector3]));u.useLayoutEffect((()=>{if(!(null==(t=e.current)?void 0:t.isSpotLight))throw new Error("SpotlightShadow must be a child of a SpotLight");var t;e.current.shadow.mapSize.set(n,o),e.current.shadow.needsUpdate=!0}),[e,n,o]),a.useFrame((()=>{if(!e.current)return;const r=e.current.position,a=e.current.target.position;s.copy(a).sub(r);var n=s.length();s.normalize().multiplyScalar(n*i),l.copy(r).add(s),t.current.position.copy(l),t.current.lookAt(e.current.target.position)}))}function c({distance:e=.4,alphaTest:t=.5,map:o,shader:i="#define GLSLIFY 1\nvarying vec2 vUv;uniform sampler2D uShadowMap;uniform float uTime;void main(){vec3 color=texture2D(uShadowMap,vUv).xyz;gl_FragColor=vec4(color,1.);}",width:l=512,height:c=512,scale:p=1,children:m,...d}){const h=u.useRef(null),f=d.spotlightRef,g=d.debug;s(f,h,l,c,e);const v=u.useMemo((()=>new r.WebGLRenderTarget(l,c,{format:r.RGBAFormat,stencilBuffer:!1})),[l,c]),w=u.useRef({uShadowMap:{value:o},uTime:{value:0}});u.useEffect((()=>{w.current.uShadowMap.value=o}),[o]);const S=u.useMemo((()=>new n.FullScreenQuad(new r.ShaderMaterial({uniforms:w.current,vertexShader:"\n          varying vec2 vUv;\n\n          void main() {\n            vUv = uv;\n            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n          }\n          ",fragmentShader:i}))),[i]);return u.useEffect((()=>()=>{S.material.dispose(),S.dispose()}),[S]),u.useEffect((()=>()=>v.dispose()),[v]),a.useFrame((({gl:e},t)=>{w.current.uTime.value+=t,e.setRenderTarget(v),S.render(e),e.setRenderTarget(null)})),u.createElement(u.Fragment,null,u.createElement("mesh",{ref:h,scale:p,castShadow:!0},u.createElement("planeGeometry",null),u.createElement("meshBasicMaterial",{transparent:!0,side:r.DoubleSide,alphaTest:t,alphaMap:v.texture,"alphaMap-wrapS":r.RepeatWrapping,"alphaMap-wrapT":r.RepeatWrapping,opacity:g?1:0},m)))}function p({distance:e=.4,alphaTest:t=.5,map:a,width:n=512,height:o=512,scale:i,children:l,...c}){const p=u.useRef(null),m=c.spotlightRef,d=c.debug;return s(m,p,n,o,e),u.createElement(u.Fragment,null,u.createElement("mesh",{ref:p,scale:i,castShadow:!0},u.createElement("planeGeometry",null),u.createElement("meshBasicMaterial",{transparent:!0,side:r.DoubleSide,alphaTest:t,alphaMap:a,"alphaMap-wrapS":r.RepeatWrapping,"alphaMap-wrapT":r.RepeatWrapping,opacity:d?1:0},l)))}const m=u.forwardRef((({opacity:t=1,radiusTop:r,radiusBottom:a,depthBuffer:n,color:o="white",distance:i=5,angle:s=.15,attenuation:c=5,anglePower:p=5,volumetric:m=!0,debug:d=!1,children:h,...f},g)=>{const v=u.useRef(null);return u.useImperativeHandle(g,(()=>v.current),[]),u.createElement("group",null,d&&v.current&&u.createElement("spotLightHelper",{args:[v.current]}),u.createElement("spotLight",e({ref:v,angle:s,color:o,distance:i,castShadow:!0},f),m&&u.createElement(l,{debug:d,opacity:t,radiusTop:r,radiusBottom:a,depthBuffer:n,color:o,distance:i,angle:s,attenuation:c,anglePower:p})),h&&u.cloneElement(h,{spotlightRef:v,debug:d}))}));exports.SpotLight=m,exports.SpotLightShadow=function(e){return e.shader?u.createElement(c,e):u.createElement(p,e)};
