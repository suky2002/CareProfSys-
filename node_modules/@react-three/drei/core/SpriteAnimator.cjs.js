"use strict";var e=require("@babel/runtime/helpers/extends"),r=require("react"),t=require("@react-three/fiber"),n=require("three"),u=require("./Instances.cjs.js"),a=require("./useSpriteLoader.cjs.js");function c(e){var r=Object.create(null);return e&&Object.keys(e).forEach((function(t){if("default"!==t){var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,n.get?n:{enumerable:!0,get:function(){return e[t]}})}})),r.default=e,Object.freeze(r)}require("react-composer"),require("../helpers/deprecated.cjs.js");var s=c(r),l=c(n);const o=s.createContext(null);const i=new l.PlaneGeometry(1,1),f=s.forwardRef((({startFrame:r,endFrame:n,fps:c,frameName:f,textureDataURL:m,textureImageURL:p,loop:d,numberOfFrames:h,autoPlay:y,animationNames:v,onStart:w,onEnd:E,onLoopEnd:g,onFrame:x,play:F,pause:S,flipX:b,alphaTest:R,children:j,asSprite:A,offset:M,playBackwards:z,resetOnEnd:O,maxItems:N,instanceItems:q,spriteDataset:L,canvasRenderingContext2DSettings:T,roundFramePosition:k=!1,meshProps:D={},...I},P)=>{var C;const U=s.useRef(),B=s.useRef(null),G=s.useRef(),H=s.useRef(),J=s.useRef(window.performance.now()),V=s.useRef(r||0),W=s.useRef(f||""),X=(null!=c?c:30)>0?1e3/(c||30):0,[K,Q]=s.useState(new l.Texture),Y=s.useRef(0),[Z,$]=s.useState([1,1,1]),_=b?-1:1,[ee,re]=s.useState(null==A||A),te=s.useRef(S),ne=s.useRef(M),ue=s.useRef(!1),ae=s.useRef([]),{spriteObj:ce,loadJsonAndTexture:se}=a.useSpriteLoader(null,null,v,h,void 0,T);function le(){}const oe=s.useMemo((()=>({current:ne.current,offset:ne.current,imageUrl:p,reset:le,hasEnded:!1,ref:P})),[p,L]);s.useImperativeHandle(P,(()=>U.current),[]),s.useLayoutEffect((()=>{ne.current=M}),[M]);const ie=(e,r)=>{const t=r/e;return H.current&&H.current.scale.set(1,t,1),[1,t,1]};s.useEffect((()=>{var e;L?fe(null==L||null==(e=L.spriteTexture)?void 0:e.clone(),L.spriteData):p&&m&&se(p,m)}),[L]),s.useEffect((()=>{var e;ce&&fe(null==ce||null==(e=ce.spriteTexture)?void 0:e.clone(),null==ce?void 0:ce.spriteData)}),[ce]),s.useEffect((()=>{re(null==A||A)}),[A]),s.useEffect((()=>{oe.hasEnded=!1,B.current&&!0===z?V.current=B.current.frames.length-1:V.current=0}),[z]),s.useLayoutEffect((()=>{me()}),[K,b]),s.useEffect((()=>{y&&(te.current=!1)}),[y]),s.useLayoutEffect((()=>{if(W.current!==f&&f&&(V.current=0,W.current=f,oe.hasEnded=!1,X<=0&&(V.current=n||r||0),B.current)){const{w:e,h:r}=de(B.current.frames).sourceSize,t=ie(e,r);$(t)}}),[f,X]);const fe=(e,r=null)=>{if(null===r){if(h){const t=e.image.width,n=e.image.height;Y.current=h,z&&(V.current=h-1),B.current={frames:[],meta:{version:"1.0",size:{w:t,h:n},scale:"1"}},B.current.frames=r}}else{B.current=r,Y.current=B.current.frames.length,z&&(V.current=Y.current-1);const{w:t,h:n}=de(B.current.frames).sourceSize,u=ie(t,n);$(u),G.current&&(G.current.map=e)}if(q)for(var t=0;t<q.length;t++){const e=Object.keys(B.current.frames),r=e[Math.floor(Math.random()*e.length)];ae.current.push({key:t,frames:B.current.frames,selectedFrame:r,offset:{x:0,y:0}})}Q(e)},me=()=>{if(!B.current)return;const{meta:{size:e},frames:r}=B.current,{w:t,h:n}=Array.isArray(r)?r[0].sourceSize:f&&r[f]?r[f][0].sourceSize:{w:0,h:0};G.current.map.wrapS=G.current.map.wrapT=l.RepeatWrapping,G.current.map.center.set(0,0),G.current.map.repeat.set(1*_/(e.w/t),1/(e.h/n));const u=1/((e.h-1)/n);G.current.map.offset.x=0,G.current.map.offset.y=1-u,w&&w({currentFrameName:f,currentFrame:V.current})},pe=(e,r,t,n)=>{var u=void 0===M?oe.current:M;const a=V.current;let c=0,s=0;ie(e,r);const l=k?Math.round((t.w-1)/e):(t.w-1)/e,o=k?Math.round((t.h-1)/r):(t.h-1)/r;if(!n[a])return;const{frame:{x:i,y:f},sourceSize:{w:m,h:p}}=n[a],d=1/l,h=1/o;if(c=_>0?d*(i/m):d*(i/m)-G.current.map.repeat.x,s=Math.abs(1-h)-h*(f/p),G.current.map.offset.x=c,G.current.map.offset.y=s,null!=u){let e=Math.floor(u*n.length);e=Math.max(0,Math.min(e,n.length-1)),isNaN(e)&&(e=0),V.current=e}else z?V.current-=1:V.current+=1};t.useFrame(((e,t)=>{var u,a;null!=(u=B.current)&&u.frames&&null!=(a=G.current)&&a.map&&(te.current||oe.hasEnded||!y&&!F||((()=>{const{meta:{size:e},frames:t}=B.current,{w:u,h:a}=de(t).sourceSize,c=Array.isArray(t)?t:f?t[f]:[],s=n||c.length-1;var l=void 0===M?oe.current:M;if(X<=0)return V.current=n||r||0,void pe(u,a,e,c);const o=window.performance.now(),i=o-J.current;if(!(i<=X)){var m=z?V.current<0:V.current>s,p=z?V.current===s:0===V.current,h=z?V.current<0:V.current>=s;if(m){if(V.current=d&&null!=r?r:0,z&&(V.current=s),d?null==g||g({currentFrameName:f,currentFrame:V.current}):(null==E||E({currentFrameName:f,currentFrame:V.current}),oe.hasEnded=!O,O&&(te.current=!0)),!d)return}else p&&(null==w||w({currentFrameName:f,currentFrame:V.current}));void 0!==l&&h?!1===ue.current&&(null==E||E({currentFrameName:f,currentFrame:V.current}),ue.current=!0):ue.current=!1,i<=X||(J.current=o-i%X,pe(u,a,e,c))}})(),x&&x({currentFrameName:W.current,currentFrame:V.current})))}));const de=e=>{if(Array.isArray(e))return e[0];if("object"==typeof e&&null!==e){const r=Object.keys(e);return f?e[f][0]:e[r[0]][0]}return{w:0,h:0}};return s.createElement("group",e({},I,{ref:U,scale:function(e,r){let t=[];return"number"==typeof r?t=[r,r,r]:Array.isArray(r)?t=r:r instanceof l.Vector3&&(t=[r.x,r.y,r.z]),e.map(((e,r)=>e*t[r]))}(null!=Z?Z:[1,1,1],null!==(C=I.scale)&&void 0!==C?C:1)}),s.createElement(o.Provider,{value:oe},s.createElement(s.Suspense,{fallback:null},ee&&s.createElement("sprite",e({ref:H,scale:1,geometry:i},D),s.createElement("spriteMaterial",{premultipliedAlpha:!1,toneMapped:!1,ref:G,map:K,transparent:!0,alphaTest:null!=R?R:0})),!ee&&s.createElement(u.Instances,e({geometry:i,limit:null!=N?N:1},D),s.createElement("meshBasicMaterial",{premultipliedAlpha:!1,toneMapped:!1,side:l.DoubleSide,ref:G,map:K,transparent:!0,alphaTest:null!=R?R:0}),(null!=q?q:[0]).map(((r,t)=>s.createElement(u.Instance,e({key:t,ref:1===(null==q?void 0:q.length)?H:null,position:r,scale:1},D)))))),j))}));exports.SpriteAnimator=f,exports.useSpriteAnimator=function(){return s.useContext(o)};
