"use strict";var e=require("@babel/runtime/helpers/extends"),t=require("three"),r=require("react"),n=require("@react-three/fiber");function a(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var i=a(t),s=a(r);const o=new i.Matrix4,c=new i.Ray,u=new i.Sphere,l=new i.Vector3;class f extends i.Group{constructor(){super(),this.size=0,this.color=new i.Color("white"),this.instance={current:void 0},this.instanceKey={current:void 0}}get geometry(){var e;return null==(e=this.instance.current)?void 0:e.geometry}raycast(e,t){var r,n;const a=this.instance.current;if(!a||!a.geometry)return;const s=a.userData.instances.indexOf(this.instanceKey);if(-1===s||s>a.geometry.drawRange.count)return;const f=null!==(r=null==(n=e.params.Points)?void 0:n.threshold)&&void 0!==r?r:1;if(u.set(this.getWorldPosition(l),f),!1===e.ray.intersectsSphere(u))return;o.copy(a.matrixWorld).invert(),c.copy(e.ray).applyMatrix4(o);const d=f/((this.scale.x+this.scale.y+this.scale.z)/3),m=d*d,y=c.distanceSqToPoint(this.position);if(y<m){const r=new i.Vector3;c.closestPointToPoint(this.position,r),r.applyMatrix4(this.matrixWorld);const n=e.ray.origin.distanceTo(r);if(n<e.near||n>e.far)return;t.push({distance:n,distanceToRay:Math.sqrt(y),point:r,index:s,face:null,object:this})}}}let d,m;const y=s.createContext(null),p=new i.Matrix4,h=new i.Vector3,g=s.forwardRef((({children:t,range:r,limit:a=1e3,...o},c)=>{const u=s.useRef(null);s.useImperativeHandle(c,(()=>u.current),[]);const[l,f]=s.useState([]),[[g,b,x]]=s.useState((()=>[new Float32Array(3*a),Float32Array.from({length:3*a},(()=>1)),Float32Array.from({length:a},(()=>1))]));s.useEffect((()=>{u.current.geometry.attributes.position.needsUpdate=!0})),n.useFrame((()=>{for(u.current.updateMatrix(),u.current.updateMatrixWorld(),p.copy(u.current.matrixWorld).invert(),u.current.geometry.drawRange.count=Math.min(a,void 0!==r?r:a,l.length),d=0;d<l.length;d++)m=l[d].current,m.getWorldPosition(h).applyMatrix4(p),h.toArray(g,3*d),u.current.geometry.attributes.position.needsUpdate=!0,m.matrixWorldNeedsUpdate=!0,m.color.toArray(b,3*d),u.current.geometry.attributes.color.needsUpdate=!0,x.set([m.size],d),u.current.geometry.attributes.size.needsUpdate=!0}));const w=s.useMemo((()=>({getParent:()=>u,subscribe:e=>(f((t=>[...t,e])),()=>f((t=>t.filter((t=>t.current!==e.current)))))})),[]);return s.createElement("points",e({userData:{instances:l},matrixAutoUpdate:!1,ref:u,raycast:()=>null},o),s.createElement("bufferGeometry",null,s.createElement("bufferAttribute",{attach:"attributes-position",count:g.length/3,array:g,itemSize:3,usage:i.DynamicDrawUsage}),s.createElement("bufferAttribute",{attach:"attributes-color",count:b.length/3,array:b,itemSize:3,usage:i.DynamicDrawUsage}),s.createElement("bufferAttribute",{attach:"attributes-size",count:x.length,array:x,itemSize:1,usage:i.DynamicDrawUsage})),s.createElement(y.Provider,{value:w},t))})),b=s.forwardRef((({children:t,...r},a)=>{s.useMemo((()=>n.extend({PositionPoint:f})),[]);const i=s.useRef(null);s.useImperativeHandle(a,(()=>i.current),[]);const{subscribe:o,getParent:c}=s.useContext(y);return s.useLayoutEffect((()=>o(i)),[]),s.createElement("positionPoint",e({instance:c(),instanceKey:i,ref:i},r),t)})),x=s.forwardRef((({children:t,positions:r,colors:a,sizes:o,stride:c=3,...u},l)=>{const f=s.useRef(null);return s.useImperativeHandle(l,(()=>f.current),[]),n.useFrame((()=>{const e=f.current.geometry.attributes;e.position.needsUpdate=!0,a&&(e.color.needsUpdate=!0),o&&(e.size.needsUpdate=!0)})),s.createElement("points",e({ref:f},u),s.createElement("bufferGeometry",null,s.createElement("bufferAttribute",{attach:"attributes-position",count:r.length/c,array:r,itemSize:c,usage:i.DynamicDrawUsage}),a&&s.createElement("bufferAttribute",{attach:"attributes-color",count:a.length/c,array:a,itemSize:3,usage:i.DynamicDrawUsage}),o&&s.createElement("bufferAttribute",{attach:"attributes-size",count:o.length/c,array:o,itemSize:1,usage:i.DynamicDrawUsage})),t)})),w=s.forwardRef(((t,r)=>t.positions instanceof Float32Array?s.createElement(x,e({},t,{ref:r})):s.createElement(g,e({},t,{ref:r}))));exports.Point=b,exports.Points=w,exports.PointsBuffer=x,exports.PositionPoint=f;
