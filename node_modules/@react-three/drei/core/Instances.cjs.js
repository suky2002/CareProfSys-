"use strict";var e=require("@babel/runtime/helpers/extends"),t=require("three"),r=require("react"),n=require("@react-three/fiber"),a=require("react-composer"),s=require("../helpers/deprecated.cjs.js");function c(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var i=c(t),o=c(r);const u=new i.Matrix4,l=new i.Matrix4,f=[],m=new i.Mesh;class d extends i.Group{constructor(){super(),this.color=new i.Color("white"),this.instance={current:void 0},this.instanceKey={current:void 0}}get geometry(){var e;return null==(e=this.instance.current)?void 0:e.geometry}raycast(e,t){const r=this.instance.current;if(!r)return;if(!r.geometry||!r.material)return;m.geometry=r.geometry;const n=r.matrixWorld,a=r.userData.instances.indexOf(this.instanceKey);if(!(-1===a||a>r.count)){r.getMatrixAt(a,u),l.multiplyMatrices(n,u),m.matrixWorld=l,r.material instanceof i.Material?m.material.side=r.material.side:m.material.side=r.material[0].side,m.raycast(e,f);for(let e=0,r=f.length;e<r;e++){const r=f[e];r.instanceId=a,r.object=this,t.push(r)}f.length=0}}}const y=o.createContext(null),p=new i.Matrix4,g=new i.Matrix4,h=new i.Matrix4,x=new i.Vector3,b=new i.Quaternion,w=new i.Vector3,M=o.forwardRef((({context:t,children:r,...a},s)=>{o.useMemo((()=>n.extend({PositionMesh:d})),[]);const c=o.useRef();o.useImperativeHandle(s,(()=>c.current),[]);const{subscribe:i,getParent:u}=o.useContext(t||y);return o.useLayoutEffect((()=>i(c)),[]),o.createElement("positionMesh",e({instance:u(),instanceKey:c,ref:c},a),r)})),A=o.forwardRef((({context:t,children:r,range:a,limit:c=1e3,frames:u=1/0,...l},f)=>{const[{localContext:m,instance:d}]=o.useState((()=>{const t=o.createContext(null);return{localContext:t,instance:o.forwardRef(((r,n)=>o.createElement(M,e({context:t},r,{ref:n}))))}})),A=o.useRef(null);o.useImperativeHandle(f,(()=>A.current),[]);const[v,E]=o.useState([]),[[D,R]]=o.useState((()=>{const e=new Float32Array(16*c);for(let t=0;t<c;t++)h.identity().toArray(e,16*t);return[e,new Float32Array([...new Array(3*c)].map((()=>1)))]}));o.useEffect((()=>{A.current.instanceMatrix.needsUpdate=!0}));let j=0,O=0;const C=o.useRef([]);o.useLayoutEffect((()=>{C.current=Object.entries(A.current.geometry.attributes).filter((([e,t])=>t.isInstancedBufferAttribute))})),n.useFrame((()=>{if(u===1/0||j<u){A.current.updateMatrix(),A.current.updateMatrixWorld(),p.copy(A.current.matrixWorld).invert(),O=Math.min(c,void 0!==a?a:c,v.length),A.current.count=O,s.setUpdateRange(A.current.instanceMatrix,{offset:0,count:16*O}),s.setUpdateRange(A.current.instanceColor,{offset:0,count:3*O});for(let e=0;e<v.length;e++){const t=v[e].current;t.matrixWorld.decompose(x,b,w),g.compose(x,b,w).premultiply(p),g.toArray(D,16*e),A.current.instanceMatrix.needsUpdate=!0,t.color.toArray(R,3*e),A.current.instanceColor.needsUpdate=!0}j++}}));const U=o.useMemo((()=>({getParent:()=>A,subscribe:e=>(E((t=>[...t,e])),()=>E((t=>t.filter((t=>t.current!==e.current)))))})),[]);return o.createElement("instancedMesh",e({userData:{instances:v,limit:c,frames:u},matrixAutoUpdate:!1,ref:A,args:[null,null,0],raycast:()=>null},l),o.createElement("instancedBufferAttribute",{attach:"instanceMatrix",count:D.length/16,array:D,itemSize:16,usage:i.DynamicDrawUsage}),o.createElement("instancedBufferAttribute",{attach:"instanceColor",count:R.length/3,array:R,itemSize:3,usage:i.DynamicDrawUsage}),"function"==typeof r?o.createElement(m.Provider,{value:U},r(d)):t?o.createElement(t.Provider,{value:U},r):o.createElement(y.Provider,{value:U},r))})),v=o.forwardRef((function({meshes:t,children:r,...n},s){const c=Array.isArray(t);if(!c)for(const e of Object.keys(t))t[e].isMesh||delete t[e];return o.createElement("group",{ref:s},o.createElement(a,{components:(c?t:Object.values(t)).map((({geometry:t,material:r})=>o.createElement(A,e({key:t.uuid,geometry:t,material:r},n))))},(e=>c?r(...e):r(Object.keys(t).filter((e=>t[e].isMesh)).reduce(((t,r,n)=>({...t,[r]:e[n]})),{})))))}));const E=o.forwardRef((({name:e,defaultValue:t,normalized:r,usage:a=i.DynamicDrawUsage},s)=>{const c=o.useRef(null);o.useImperativeHandle(s,(()=>c.current),[]),o.useLayoutEffect((()=>{const r=c.current.__r3f.parent;r.geometry.attributes[e]=c.current;const n=Array.isArray(t)?t:[t],a=Array.from({length:r.userData.limit},(()=>n)).flat();return c.current.array=new Float32Array(a),c.current.itemSize=n.length,c.current.count=a.length/c.current.itemSize,()=>{delete r.geometry.attributes[e]}}),[e]);let u=0;return n.useFrame((()=>{const t=c.current.__r3f.parent;if(t.userData.frames===1/0||u<t.userData.frames){for(let r=0;r<t.userData.instances.length;r++){const n=t.userData.instances[r].current[e];void 0!==n&&(c.current.set(Array.isArray(n)?n:"function"==typeof n.toArray?n.toArray():[n],r*c.current.itemSize),c.current.needsUpdate=!0)}u++}})),o.createElement("instancedBufferAttribute",{ref:c,usage:a,normalized:r})}));exports.Instance=M,exports.InstancedAttribute=E,exports.Instances=A,exports.Merged=v,exports.PositionMesh=d,exports.createInstances=function(){const t=o.createContext(null);return[o.forwardRef(((r,n)=>o.createElement(A,e({ref:n,context:t},r)))),o.forwardRef(((r,n)=>o.createElement(M,e({ref:n,context:t},r))))]};
